# P2: Medium Priority Issues

---

## 1. Missing Field-Level Privacy

**Files:** `server/controllers/authController.ts`

**Issue:** `/auth/me` endpoint returns entire User object with all fields.

**Why Dangerous:** Exposes internal fields like `accountId`, database IDs, and
potentially sensitive data.

**Solution:** Return only necessary fields:

```typescript
res.json({
  id: user.id,
  email: user.email,
  name: user.name,
  // Omit accountId, supabaseId, etc.
});
```

---

## 2. Unclear Account/User Security Boundary

**Files:** Various service files

**Issue:** Code accepts both `userId` and `accountId` but unclear which is the
security boundary for RLS.

**Why Dangerous:** Confusion between user and account isolation could lead to
bugs. Multiple users in same account might have data leakage.

**Solution:**

- Document whether RLS uses `account_id` or `user_id`
- Ensure all queries consistently filter by the correct boundary
- Add tests for multi-user account scenarios

---

## 3. Filename Sanitization Improvements

**Files:** `server/services/supabase/storageService.ts:19-23`

**Issue:** Basic sanitization present but missing:

- Unicode normalization
- Null byte injection checks
- Path traversal validation before sanitization

**Why Dangerous:** Edge cases could allow file system attacks or encoding
exploits.

**Solution:** Enhanced sanitization:

```typescript
if (filename.includes('\0') || filename.includes('../')) {
  throw new Error('Invalid filename');
}
const sanitized = filename.normalize('NFC')...
```

---

## 4. Markdown Rendering XSS Risk

**Files:** React components using `react-markdown`

**Issue:** `react-markdown` dependency could enable XSS if user content is
rendered without sanitization.

**Why Dangerous:** Markdown can contain HTML. Without sanitization,
`[click](javascript:alert('xss'))` or embedded HTML could execute.

**Solution:** Install `rehype-sanitize` and configure:

```typescript
import rehypeSanitize from 'rehype-sanitize';
<ReactMarkdown rehypePlugins={[rehypeSanitize]} />;
```

---

## 5. Pyodide Script Security Warning

**Files:** `public/src/workers/pyodide/PyodideController.ts`

**Issue:** Shared workflows execute Python scripts in user's browser without
warning.

**Why Dangerous:** Scripts execute with user's browser privileges. Could
exfiltrate data via network requests (limited by CORS).

**Solution:** Add warning when running shared workflows:

```
"This workflow was created by another user. Review the code before running."
```

Display script code for user review before execution.
