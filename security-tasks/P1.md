# P1: High Priority Issues

---

## 1. Hardcoded Admin Email

**Files:** `server/middleware/auth.ts:4`

**Issue:** Admin check uses hardcoded email `'jonathanfarache@gmail.com'`.

**Why Dangerous:** Not scalable, can't add/remove admins without code changes.
If email compromised, no easy way to revoke.

**Solution:** Add `role` field to User model. Check `req.user.role === 'admin'`
instead of email comparison.

---

## 2. TODO Endpoints Exposed

**Files:** `server/controllers/workflowsController.ts`

**Issue:** Multiple endpoints (`getWorkflow`, `sendMessage`, `approveWorkflow`,
`editWorkflow`) are stubbed as `// TODO` but still exposed in routes.

**Why Dangerous:** When implemented without proper authorization, could allow
unauthorized access. Currently return 500 errors.

**Solution:** Either implement with proper authorization or remove from routes
until ready.

---

## 3. Missing Workflow Ownership Validation

**Files:** `server/controllers/workflowsController.ts` (TODO endpoints)

**Issue:** TODO endpoints don't verify user owns/has access to workflow before
operations.

**Why Dangerous:** When implemented, users could modify workflows they don't
own.

**Solution:** Add `hasWorkflowAccess(workflowId, userId)` check (already exists
in codebase) to all workflow operations.

---

## 4. Weak Share Code Length

**Files:** `server/services/workflows/shareService.ts:13`

**Issue:** Share codes use `nanoid(8)` - only 48 bits of entropy.

**Why Dangerous:** Could be brute-forced without rate limiting. While
cryptographically secure, 8 characters is low for public share codes.

**Solution:** Increase to `nanoid(12)` for 72 bits of entropy.

---

## 5. Input Validation Gaps

**Files:** Multiple controllers

**Issue:**

- No NaN validation after `parseInt(req.params.id)`
- No schema validation library (Joi, Yup, Zod)
- No string length limits
- No type validation for complex objects

**Why Dangerous:** Invalid inputs could cause crashes or unexpected behavior.
Poor error messages for users.

**Solution:** Install Zod and create validation schemas for all request bodies
and params:

```typescript
const workflowIdSchema = z.number().int().positive();
```

---

## 6. Command Execution in Migrations

**Files:** `server/server.ts:33-41`

**Issue:** Uses `exec('pnpm run migrate')` to run migrations via shell.

**Why Dangerous:** While hardcoded command is safe, establishes pattern of shell
execution. Could be copied for dynamic commands.

**Solution:** Use Sequelize's built-in migration runner or `umzug` library
instead of shell execution.

---

## 7. No CORS Middleware

**Files:** `server/server.ts`

**Issue:** No CORS package installed or configured.

**Why Dangerous:** Future API consumers would be blocked. Currently mitigated by
same-origin deployment.

**Solution:** Install `cors` package:

```typescript
app.use(cors({ origin: process.env.FRONTEND_URL }));
```

---

## 8. No Audit Logging

**Files:** N/A (missing feature)

**Issue:** No logging for sensitive operations (admin actions, sharing, auth
failures).

**Why Dangerous:** No forensic trail if security incident occurs. Can't detect
suspicious activity.

**Solution:** Create audit_logs table and middleware to log:

- Failed authentication attempts
- Authorization failures
- Admin actions
- Workflow sharing/acceptance
- Workflow deletions
